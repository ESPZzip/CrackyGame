<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Juego de Cajas - Un solo HTML</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--accent:#6f42c1}
    body{background:#0f1724;color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.15));border:0}
    .accent{color:var(--accent)}
    .btn-accent{background:var(--accent);border:0}
    .small-muted{color:#9fb0c8;font-size:.9rem}
    .item-img{width:64px;height:64px;object-fit:cover;border-radius:8px}
    .box-img{width:120px;height:80px;object-fit:cover;border-radius:8px}
    .hidden{display:none}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  </style>
</head>
<body class="p-3">
  <div class="container">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="m-0">🎁 Juego de Cajas</h2>
      <div id="userArea"></div>
    </header>

    <main class="row">
      <section class="col-md-8">
        <div id="authPanel" class="card p-3 mb-3">
          <h5>Registrarse / Iniciar sesión</h5>
          <div id="authForms">
            <div id="registerForm">
              <input id="regUser" class="form-control mb-2" placeholder="Usuario (ej: cracky)" />
              <input id="regPass" type="password" class="form-control mb-2" placeholder="Contraseña" />
              <button id="btnRegister" class="btn btn-accent text-white">Registrarse</button>
              <div class="small-muted mt-2">Al registrarte recibes 100 monedas.</div>
            </div>
            <hr/>
            <div id="loginForm">
              <input id="logUser" class="form-control mb-2" placeholder="Usuario" />
              <input id="logPass" type="password" class="form-control mb-2" placeholder="Contraseña" />
              <button id="btnLogin" class="btn btn-outline-light">Iniciar sesión</button>
            </div>
          </div>
        </div>

        <div id="boxesPanel" class="card p-3 mb-3 hidden">
          <h5>Cajas disponibles</h5>
          <div id="boxesList" class="d-flex gap-3 flex-wrap"></div>
        </div>

        <div id="inventoryPanel" class="card p-3 mb-3 hidden">
          <h5>Inventario</h5>
          <div id="inventoryList" class="inventory-grid mt-2"></div>
        </div>

        <div id="codesPanel" class="card p-3 mb-3 hidden">
          <h5>Canjear código</h5>
          <div class="d-flex gap-2">
            <input id="codeInput" class="form-control" placeholder="Introduce código" />
            <button id="btnRedeem" class="btn btn-accent text-white">Canjear</button>
          </div>
          <div id="codeMsg" class="mt-2 small-muted"></div>
        </div>

      </section>

      <aside class="col-md-4">
        <div id="profileCard" class="card p-3 mb-3 hidden">
          <h6>Perfil</h6>
          <div><strong id="displayUser">Usuario</strong></div>
          <div class="small-muted">Monedas: <span id="coins">0</span></div>
          <div class="small-muted">UID: <span id="uid"></span></div>
          <button id="btnLogout" class="btn btn-outline-light btn-sm mt-2">Cerrar sesión</button>
        </div>

        <div id="adminPanel" class="card p-3 mb-3 hidden">
          <h6>Admin Panel (cracky)</h6>
          <!-- el panel se mantiene igual que antes -->
          ...
        </div>

      </aside>
    </main>

    <footer class="mt-4 small-muted">Hecho con ❤️ - Single HTML + Firebase (cliente). Atención: este sistema funciona desde el cliente; para producción necesitas reglas de seguridad en Firestore/Storage.</footer>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  const firebaseConfig = { /* tu config */ };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  let currentUser = null; // guardamos usuario en memoria

  // === Registro manual ===
  $('btnRegister').addEventListener('click', async ()=>{
    const username = $('regUser').value.trim();
    const pass = $('regPass').value;
    if(!username||!pass) return alert('Rellena usuario y contraseña');
    // comprobar si ya existe
    const snap = await db.collection('users').where('username','==',username).get();
    if(!snap.empty) return alert('Ese usuario ya existe');
    const isAdmin = username.toLowerCase()==='cracky';
    const ref = await db.collection('users').add({username, pass, coins:100, inventory:[], isAdmin});
    localStorage.setItem('uid', ref.id);
    loadSession(ref.id);
  });

  // === Login manual ===
  $('btnLogin').addEventListener('click', async ()=>{
    const username = $('logUser').value.trim();
    const pass = $('logPass').value;
    const snap = await db.collection('users').where('username','==',username).where('pass','==',pass).get();
    if(snap.empty) return alert('Usuario o contraseña incorrectos');
    const doc = snap.docs[0];
    localStorage.setItem('uid', doc.id);
    loadSession(doc.id);
  });

  $('btnLogout').addEventListener('click', ()=>{
    localStorage.removeItem('uid');
    location.reload();
  });

  async function loadSession(uid){
    const doc = await db.collection('users').doc(uid).get();
    if(!doc.exists) return;
    currentUser = {id:doc.id,...doc.data()};
    hide($('authPanel'));
    show($('boxesPanel')); show($('inventoryPanel')); show($('codesPanel')); show($('profileCard'));
    $('displayUser').textContent=currentUser.username;
    $('coins').textContent=currentUser.coins;
    $('uid').textContent=currentUser.id;
    if(currentUser.isAdmin) show($('adminPanel')); else hide($('adminPanel'));
    renderBoxes(); renderInventory(currentUser.inventory);
  }

  // al cargar página
  window.addEventListener('DOMContentLoaded', ()=>{
    const uid = localStorage.getItem('uid');
    if(uid) loadSession(uid);
  });

  // ... resto de funciones (cajas, inventario, admin, códigos) se mantienen igual pero usando currentUser.id en vez de auth.currentUser
  </script>
</body>
</html>
