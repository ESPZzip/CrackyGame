<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego Abrir Cajas</title>
<style>
:root { --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; --muted:#9aa4b2; --glass:rgba(255,255,255,0.04); }
* { box-sizing:border-box; font-family: Inter, system-ui, sans-serif; }
body { margin:0; background: var(--bg); color:#e6eef8; }
.container { max-width:1100px; margin:24px auto; padding:24px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
h1 { margin:0; font-size:20px; }
.row { display:flex; gap:16px; }
.col { background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,0.7); }
.left { flex:2; min-width:320px; }
.right { flex:1; min-width:320px; }
button { background:var(--accent); border:0; padding:10px 12px; border-radius:10px; color:white; cursor:pointer; }
input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--glass); color:inherit; }
.box-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
.box-card, .inv-card { padding:12px; border-radius:10px; background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent); display:flex; flex-direction:column; gap:8px; }
.item-img { width:72px; height:72px; border-radius:8px; background:#061225; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--muted); overflow:hidden; }
small { color:var(--muted); }
.inventory-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px; }
.admin-panel { display:flex; flex-direction:column; gap:10px; }
.hidden { display:none; }
.topbar { display:flex; gap:8px; align-items:center; }
.coins { background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>Abrir Cajas</h1>
<div class="topbar">
<div class="coins" id="userCoins">Invitado</div>
<div id="authButtons"></div>
</div>
</header>
<div class="row">
<div class="col left">
<section id="authSection">
<h3>Registrarse / Iniciar Sesi√≥n</h3>
<div style="display:flex;gap:12px; flex-wrap:wrap;">
<input id="username" placeholder="Nombre de usuario" />
<input id="password" placeholder="Contrase√±a" type="password" />
<button id="registerBtn">Registrarse</button>
<button id="loginBtn">Iniciar</button>
</div>
<small>Al registrarte recibes <strong>100 monedas</strong>. Usuario admin: <strong>cracky</strong>.</small>
</section>
<hr />
<section>
<h3>Cajas Disponibles</h3>
<div class="box-list" id="boxes"></div>
</section>
<hr />
<section>
<h3>Canjear C√≥digo</h3>
<div style="display:flex; gap:8px; flex-wrap:wrap;">
<input id="redeemCode" placeholder="Ingresa c√≥digo" />
<button id="redeemBtn">Canjear</button>
</div>
<div id="redeemResult"></div>
</section>
</div>
<div class="col right">
<section>
<h3>Tu Inventario</h3>
<div id="invUser" class="inventory-list"></div>
</section>
<hr />
<section id="adminSection" class="hidden">
<h3>Admin Panel (cracky)</h3>
<div class="admin-panel">
<!-- Aqu√≠ se agregan cajas, items y c√≥digos con imagen, rareza y probabilidad -->
</div>
</section>
</div>
</div>
</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, getDocs, addDoc, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

const firebaseConfig = {
apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
authDomain: "pekora-forum.firebaseapp.com",
projectId: "pekora-forum",
storageBucket: "pekora-forum.firebasestorage.app",
messagingSenderId: "161910967859",
appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
measurementId: "G-BPBTW5KBRK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const $ = id=>document.getElementById(id);
let currentUser = null;
const SESSION_KEY = 'boxgame_user_v1';
const ADMIN_PASSWORD = 'cracky1010';

const authSection=$('authSection'),usernameInput=$('username'),passwordInput=$('password'),registerBtn=$('registerBtn'),loginBtn=$('loginBtn'),userCoinsEl=$('userCoins'),authButtons=$('authButtons'),boxesEl=$('boxes'),invUser=$('invUser'),redeemInput=$('redeemCode'),redeemBtn=$('redeemBtn'),redeemResult=$('redeemResult'),adminSection=$('adminSection');

function logoutUser(){
 localStorage.removeItem(SESSION_KEY);
 currentUser=null;
 authSection.classList.remove('hidden');
 authButtons.innerHTML='';
 userCoinsEl.textContent='Invitado';
 invUser.innerHTML='Inicia sesi√≥n para ver inventario.';
 adminSection.classList.add('hidden');
}

async function findUserByUsername(username){
 const ref=doc(db,'users',username);
 const snap=await getDoc(ref);
 return snap.exists()?{id:snap.id,...snap.data()}:null;
}

registerBtn.onclick=async()=>{
 const username=usernameInput.value.trim(),password=passwordInput.value;
 if(!username||!password){alert('Usuario y contrase√±a requeridos');return;}
 const exists=await findUserByUsername(username);
 if(exists){alert('Usuario ya existe');return;}
 const isAdmin=username.toLowerCase()==='cracky';
 await setDoc(doc(db,'users',username),{username,password,coins:100,inventory:[],isAdmin});
 currentUser={id:username,username,isAdmin};
 localStorage.setItem(SESSION_KEY,JSON.stringify(currentUser));
 authSection.classList.add('hidden');
 await refreshUserUI();
 alert('Registrado con 100 monedas');
};

loginBtn.onclick=async()=>{
 const username=usernameInput.value.trim(),password=passwordInput.value;
 if(!username||!password){alert('Usuario y contrase√±a requeridos');return;}
 const u=await findUserByUsername(username);
 if(!u){alert('Usuario no encontrado');return;}
 if(u.password!==password){alert('Contrase√±a incorrecta');return;}
 currentUser={id:username,username,isAdmin:!!u.isAdmin};
 localStorage.setItem(SESSION_KEY,JSON.stringify(currentUser));
 authSection.classList.add('hidden');
 await refreshUserUI();
 alert('Sesi√≥n iniciada');
};

async function refreshUserUI(){
 if(!currentUser){userCoinsEl.textContent='Invitado';invUser.innerHTML='Inicia sesi√≥n para ver inventario.';adminSection.classList.add('hidden');return;}
 const uSnap=await getDoc(doc(db,'users',currentUser.id));
 if(!uSnap.exists()){logoutUser();return;}
 const u=uSnap.data();
 userCoinsEl.textContent=`${u.username} ‚Äî ${u.coins||0} üí∞`;
 authButtons.innerHTML=`<button id="logoutBtn">Cerrar sesi√≥n</button>`;
 document.getElementById('logoutBtn').onclick=()=>logoutUser();
 invUser.innerHTML='';
 const itemsAll=await getDocs(collection(db,'items'));
 let inv=u.inventory||[];
 if(inv.length===0)invUser.innerHTML='<small>Inventario vac√≠o</small>';
 for(const slot of inv.slice().reverse()){
  let it=itemsAll.docs.find(i=>i.id===slot.itemId);
  const card=document.createElement('div');
  card.className='inv-card';
  card.innerHTML=`<div style="height:72px">${it?`<img src="${it.data().img}" style="max-width:100%;max-height:100%;border-radius:6px">`:'No img'}</div><div style="margin-top:6px"><strong>${it?it.data().name:slot.itemId}</strong></div>`;
  invUser.appendChild(card);
 }
 if(u.isAdmin){adminSection.classList.remove('hidden');}
}

// Cargar sesi√≥n persistente
window.addEventListener('DOMContentLoaded',()=>{
 const stored=localStorage.getItem(SESSION_KEY);
 if(stored){currentUser=JSON.parse(stored);authSection.classList.add('hidden');refreshUserUI();}
});

// Admin Panel apertura con Insert + contrase√±a
window.addEventListener('keydown',async e=>{
 if(e.key==='Insert'){ const pass=prompt('Contrase√±a admin'); if(pass===ADMIN_PASSWORD){adminSection.classList.remove('hidden');alert('Admin panel abierto');}else{alert('Contrase√±a incorrecta');}}
});
</script>
</body>
</html>
