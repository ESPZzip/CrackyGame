<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Juego de Cajas - Un solo HTML</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--accent:#6f42c1}
    body{background:#0f1724;color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.15));border:0}
    .accent{color:var(--accent)}
    .btn-accent{background:var(--accent);border:0}
    .small-muted{color:#9fb0c8;font-size:.9rem}
    .item-img{width:64px;height:64px;object-fit:cover;border-radius:8px}
    .box-img{width:120px;height:80px;object-fit:cover;border-radius:8px}
    .hidden{display:none}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  </style>
</head>
<body class="p-3">
  <div class="container">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="m-0">游꾸 Juego de Cajas</h2>
      <div id="userArea"></div>
    </header>

    <main class="row">
      <section class="col-md-8">
        <div id="authPanel" class="card p-3 mb-3">
          <h5>Registrarse / Iniciar sesi칩n</h5>
          <div id="authForms">
            <div id="registerForm">
              <input id="regUser" class="form-control mb-2" placeholder="Usuario (ej: cracky)" />
              <input id="regPass" type="password" class="form-control mb-2" placeholder="Contrase침a" />
              <button id="btnRegister" class="btn btn-accent text-white">Registrarse</button>
              <div class="small-muted mt-2">Al registrarte recibes 100 monedas.</div>
            </div>
            <hr/>
            <div id="loginForm">
              <input id="logUser" class="form-control mb-2" placeholder="Usuario" />
              <input id="logPass" type="password" class="form-control mb-2" placeholder="Contrase침a" />
              <button id="btnLogin" class="btn btn-outline-light">Iniciar sesi칩n</button>
            </div>
          </div>
        </div>

        <div id="boxesPanel" class="card p-3 mb-3 hidden">
          <h5>Cajas disponibles</h5>
          <div id="boxesList" class="d-flex gap-3 flex-wrap"></div>
        </div>

        <div id="inventoryPanel" class="card p-3 mb-3 hidden">
          <h5>Inventario</h5>
          <div id="inventoryList" class="inventory-grid mt-2"></div>
        </div>

        <div id="codesPanel" class="card p-3 mb-3 hidden">
          <h5>Canjear c칩digo</h5>
          <div class="d-flex gap-2">
            <input id="codeInput" class="form-control" placeholder="Introduce c칩digo" />
            <button id="btnRedeem" class="btn btn-accent text-white">Canjear</button>
          </div>
          <div id="codeMsg" class="mt-2 small-muted"></div>
        </div>

      </section>

      <aside class="col-md-4">
        <div id="profileCard" class="card p-3 mb-3 hidden">
          <h6>Perfil</h6>
          <div><strong id="displayUser">Usuario</strong></div>
          <div class="small-muted">Monedas: <span id="coins">0</span></div>
          <div class="small-muted">UID: <span id="uid"></span></div>
          <button id="btnLogout" class="btn btn-outline-light btn-sm mt-2">Cerrar sesi칩n</button>
        </div>

        <div id="adminPanel" class="card p-3 mb-3 hidden">
          <h6>Admin Panel (cracky)</h6>
          <hr/>
          <div>
            <h6>A침adir Item</h6>
            <input id="itemName" class="form-control mb-1" placeholder="Nombre item" />
            <input id="itemRarity" class="form-control mb-1" placeholder="Rareza (comun,rare,epic)" />
            <input id="itemImg" type="file" class="form-control mb-1" />
            <button id="btnAddItem" class="btn btn-sm btn-accent text-white mb-2">Crear Item</button>
          </div>
          <hr/>
          <div>
            <h6>A침adir Caja</h6>
            <input id="boxName" class="form-control mb-1" placeholder="Nombre caja" />
            <input id="boxPrice" type="number" class="form-control mb-1" placeholder="Precio (monedas)" />
            <input id="boxImg" type="file" class="form-control mb-1" />
            <button id="btnAddBox" class="btn btn-sm btn-accent text-white mb-2">Crear Caja</button>
          </div>
          <hr/>
          <div>
            <h6>A침adir Item a Caja</h6>
            <select id="selBox" class="form-control mb-1"></select>
            <select id="selItem" class="form-control mb-1"></select>
            <input id="itemWeight" type="number" class="form-control mb-1" placeholder="Probabilidad (peso num칠rico)" />
            <button id="btnAddItemToBox" class="btn btn-sm btn-outline-light mb-2">Agregar al Box</button>
          </div>
          <hr/>
          <div>
            <h6>Gestionar Usuarios</h6>
            <input id="manageUser" class="form-control mb-1" placeholder="Usuario destino" />
            <input id="manageCoins" type="number" class="form-control mb-1" placeholder="Monedas a regalar" />
            <button id="btnGiftCoins" class="btn btn-sm btn-accent text-white mb-1">Regalar Monedas</button>
            <button id="btnGiftItem" class="btn btn-sm btn-outline-light mb-1">Regalar Item</button>
          </div>
          <hr/>
          <div>
            <h6>A침adir C칩digo</h6>
            <input id="codeStr" class="form-control mb-1" placeholder="C칩digo (칰nico)" />
            <select id="codeType" class="form-control mb-1">
              <option value="coins">Monedas</option>
              <option value="item">Item</option>
            </select>
            <input id="codeAmount" class="form-control mb-1" placeholder="Cantidad monedas o ID item" />
            <button id="btnAddCode" class="btn btn-sm btn-accent text-white">Crear C칩digo</button>
          </div>
        </div>

      </aside>
    </main>

    <footer class="mt-4 small-muted">Hecho con 仇벒잺 - Single HTML + Firebase (cliente). Atenci칩n: este sistema funciona desde el cliente; para producci칩n necesitas reglas de seguridad en Firestore/Storage.</footer>
  </div>

  <!-- Firebase compat (m치s simple en single-file) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  // === USAR EL firebaseConfig que enviaste ===
  const firebaseConfig = {
    apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
    authDomain: "pekora-forum.firebaseapp.com",
    projectId: "pekora-forum",
    storageBucket: "pekora-forum.firebasestorage.app",
    messagingSenderId: "161910967859",
    appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
    measurementId: "G-BPBTW5KBRK"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // utilidades DOM
  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  // UI refs
  const authPanel = $('authPanel');
  const boxesPanel = $('boxesPanel');
  const inventoryPanel = $('inventoryPanel');
  const codesPanel = $('codesPanel');
  const adminPanel = $('adminPanel');
  const profileCard = $('profileCard');

  const displayUser = $('displayUser');
  const coinsEl = $('coins');
  const uidEl = $('uid');

  // REGISTER
  $('btnRegister').addEventListener('click', async ()=>{
    const username = $('regUser').value.trim();
    const pass = $('regPass').value;
    if(!username || !pass){alert('Rellena usuario y contrase침a');return}
    try{
      // usaremos email ficticio para auth
      const email = username + '@local.pekora';
      const res = await auth.createUserWithEmailAndPassword(email, pass);
      const user = res.user;
      // crear doc user en firestore
      const isAdmin = username.toLowerCase() === 'cracky';
      await db.collection('users').doc(user.uid).set({
        username, coins:100, inventory:[], isAdmin:isAdmin
      });
      if(isAdmin){console.log('Cuenta cracky: admin activado')}
      alert('Registrado! Se te han dado 100 monedas.');
    }catch(e){alert('Error: '+e.message)}
  });

  // LOGIN
  $('btnLogin').addEventListener('click', async ()=>{
    const username = $('logUser').value.trim();
    const pass = $('logPass').value;
    if(!username || !pass){alert('Rellena usuario y contrase침a');return}
    try{
      const email = username + '@local.pekora';
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){alert('Error: '+e.message)}
  });

  // LOGOUT
  $('btnLogout').addEventListener('click', ()=>auth.signOut());

  // auth state
  auth.onAuthStateChanged(async user=>{
    if(user){
      // ocultar panel de auth
      hide($('authPanel'));
      show(boxesPanel); show(inventoryPanel); show(codesPanel); show(profileCard);
      // cargar datos de usuario
      const doc = await db.collection('users').doc(user.uid).get();
      if(!doc.exists){
        // posible login con usuario creado manualmente: crear default
        const username = user.email ? user.email.split('@')[0] : 'unknown';
        await db.collection('users').doc(user.uid).set({username, coins:100, inventory:[], isAdmin:false});
      }
      const data = (await db.collection('users').doc(user.uid).get()).data();
      displayUser.textContent = data.username;
      coinsEl.textContent = data.coins;
      uidEl.textContent = user.uid;
      // mostrar admin si corresponde
      if(data.isAdmin){show(adminPanel); populateAdminSelects() } else hide(adminPanel);
      // render boxes and inventory
      renderBoxes(); renderInventory(data.inventory || []);
    } else {
      // no auth
      show($('authPanel'));
      hide(boxesPanel); hide(inventoryPanel); hide(codesPanel); hide(adminPanel); hide(profileCard);
    }
  });

  // ==== BOXES ====
  async function renderBoxes(){
    const boxesSnap = await db.collection('boxes').get();
    const boxesList = $('boxesList'); boxesList.innerHTML='';
    const selBox = $('selBox'); selBox.innerHTML='';
    boxesSnap.forEach(doc=>{
      const b = {id:doc.id,...doc.data()};
      const div = document.createElement('div'); div.className='card p-2 m-1';
      div.style.width='220px';
      div.innerHTML = `
        <img src="${b.imageURL||'https://via.placeholder.com/120x80'}" class="box-img mb-2" />
        <div><strong>${b.name}</strong></div>
        <div class="small-muted">Precio: ${b.price||0} monedas</div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-accent openBoxBtn">Abrir</button>
        </div>
      `;
      boxesList.appendChild(div);
      // open handler
      div.querySelector('.openBoxBtn').addEventListener('click', ()=>openBox(b.id));
      // admin select
      const opt = document.createElement('option'); opt.value=b.id; opt.textContent=b.name; selBox.appendChild(opt);
    });
  }

  // ==== INVENTORY ====
  function renderInventory(items){
    const inv = $('inventoryList'); inv.innerHTML='';
    if(!items || items.length===0){ inv.innerHTML='<div class="small-muted">Tu inventario est치 vac칤o</div>'; return }
    items.forEach(it =>{
      const el = document.createElement('div'); el.className='card p-2';
      el.innerHTML = `<div class="d-flex gap-2 align-items-center"><img src="${it.imageURL||'https://via.placeholder.com/64'}" class="item-img" /><div><div><strong>${it.name}</strong></div><div class="small-muted">${it.rarity||''}</div></div></div>`;
      inv.appendChild(el);
    });
  }

  // ==== OPEN BOX ====
  async function openBox(boxId){
    const user = auth.currentUser; if(!user) return alert('Inicia sesi칩n');
    const userRef = db.collection('users').doc(user.uid);
    const userDoc = await userRef.get(); const userData = userDoc.data();
    const boxDoc = await db.collection('boxes').doc(boxId).get(); if(!boxDoc.exists) return alert('Caja no existe');
    const box = boxDoc.data();
    if((userData.coins||0) < (box.price||0)) return alert('No tienes suficientes monedas');
    // restar monedas
    await userRef.update({coins: (userData.coins||0) - (box.price||0)});
    coinsEl.textContent = (userData.coins||0) - (box.price||0);
    // elegir item por 'weight'
    const items = box.items || [];
    if(items.length===0) return alert('Caja vac칤a');
    const total = items.reduce((s,i)=>s + (i.weight||1),0);
    let r = Math.random()*total; let chosen = null;
    for(const it of items){ r -= (it.weight||1); if(r<=0){ chosen = it; break }}
    if(!chosen) chosen = items[items.length-1];
    // obtener item details
    const itemDoc = await db.collection('items').doc(chosen.itemId).get();
    const itemData = itemDoc.exists ? itemDoc.data() : {name: chosen.name || 'Unknown', imageURL: chosen.imageURL || ''};
    // a침adir al inventario
    const newItem = {itemId: chosen.itemId || 'gen_'+Date.now(), name: itemData.name || chosen.name, rarity: itemData.rarity||chosen.rarity, imageURL: itemData.imageURL||chosen.imageURL||''};
    await userRef.update({inventory: firebase.firestore.FieldValue.arrayUnion(newItem)});
    // notificar
    alert('Has conseguido: ' + newItem.name);
    // recargar inventario
    const updated = (await userRef.get()).data(); renderInventory(updated.inventory || []);
  }

  // ==== ADMIN ACTIONS ====
  async function populateAdminSelects(){
    // llenar selItem
    const selItem = $('selItem'); selItem.innerHTML='';
    const itemsSnap = await db.collection('items').get();
    itemsSnap.forEach(d=>{ const it = {id:d.id,...d.data()}; const opt = document.createElement('option'); opt.value = it.id; opt.textContent = it.name; selItem.appendChild(opt); });
  }

  // upload helper
  async function uploadFile(file, path){
    const ref = storage.ref().child(path);
    const snap = await ref.put(file);
    return await snap.ref.getDownloadURL();
  }

  // add item
  $('btnAddItem').addEventListener('click', async ()=>{
    const name = $('itemName').value.trim(); const rarity = $('itemRarity').value.trim(); const file = $('itemImg').files[0];
    if(!name||!rarity) return alert('Nombre y rareza requeridos');
    const docRef = await db.collection('items').add({name, rarity, imageURL: ''});
    if(file){ const url = await uploadFile(file, `items/${docRef.id}_${file.name}`); await docRef.update({imageURL: url}); }
    alert('Item creado'); $('itemName').value=''; $('itemRarity').value=''; $('itemImg').value=''; populateAdminSelects();
  });

  // add box
  $('btnAddBox').addEventListener('click', async ()=>{
    const name = $('boxName').value.trim(); const price = Number($('boxPrice').value) || 0; const file = $('boxImg').files[0];
    if(!name) return alert('Nombre requerido');
    const docRef = await db.collection('boxes').add({name, price, imageURL:'', items:[]});
    if(file){ const url = await uploadFile(file, `boxes/${docRef.id}_${file.name}`); await docRef.update({imageURL:url}); }
    alert('Caja creada'); $('boxName').value=''; $('boxPrice').value=''; $('boxImg').value=''; renderBoxes();
  });

  // add item to box
  $('btnAddItemToBox').addEventListener('click', async ()=>{
    const boxId = $('selBox').value; const itemId = $('selItem').value; const weight = Number($('itemWeight').value) || 1;
    if(!boxId||!itemId) return alert('Selecciona caja e item');
    // get item data snapshot
    const itemDoc = await db.collection('items').doc(itemId).get(); const itemData = itemDoc.data();
    const boxRef = db.collection('boxes').doc(boxId);
    await boxRef.update({items: firebase.firestore.FieldValue.arrayUnion({itemId, name:itemData.name, rarity:itemData.rarity, imageURL:itemData.imageURL||'', weight})});
    alert('Item agregado a caja'); $('itemWeight').value=''; renderBoxes();
  });

  // gift coins
  $('btnGiftCoins').addEventListener('click', async ()=>{
    const target = $('manageUser').value.trim(); const amount = Number($('manageCoins').value)||0;
    if(!target) return alert('Usuario destino requerido');
    // buscar user por username
    const uSnap = await db.collection('users').where('username','==',target).get(); if(uSnap.empty) return alert('Usuario no encontrado');
    const uDoc = uSnap.docs[0]; await uDoc.ref.update({coins: firebase.firestore.FieldValue.increment(amount)});
    alert('Monedas regaladas');
  });

  // gift item (regalar primer item en selItem)
  $('btnGiftItem').addEventListener('click', async ()=>{
    const target = $('manageUser').value.trim(); if(!target) return alert('Usuario destino requerido');
    const selItemId = $('selItem').value; if(!selItemId) return alert('Selecciona item para regalar (en el select de "A침adir Item a Caja")');
    const uSnap = await db.collection('users').where('username','==',target).get(); if(uSnap.empty) return alert('Usuario no encontrado');
    const uDoc = uSnap.docs[0]; const itemDoc = await db.collection('items').doc(selItemId).get(); const itemData = itemDoc.data();
    const newItem = {itemId: selItemId, name: itemData.name, rarity: itemData.rarity, imageURL: itemData.imageURL||''};
    await uDoc.ref.update({inventory: firebase.firestore.FieldValue.arrayUnion(newItem)});
    alert('Item regalado');
  });

  // add code
  $('btnAddCode').addEventListener('click', async ()=>{
    const code = $('codeStr').value.trim(); const type = $('codeType').value; const amount = $('codeAmount').value.trim();
    if(!code) return alert('Codigo requerido');
    // comprobar 칰nico
    const existing = await db.collection('codes').doc(code).get(); if(existing.exists) return alert('Codigo ya existe');
    const payload = {type, usedBy:null};
    if(type==='coins') payload.amount = Number(amount)||0; else payload.itemId = amount; 
    await db.collection('codes').doc(code).set(payload);
    alert('Codigo creado'); $('codeStr').value=''; $('codeAmount').value='';
  });

  // redeem code
  $('btnRedeem').addEventListener('click', async ()=>{
    const code = $('codeInput').value.trim(); if(!code) return;
    const user = auth.currentUser; if(!user) return alert('Inicia sesi칩n');
    const codeDoc = await db.collection('codes').doc(code).get(); if(!codeDoc.exists) return $('codeMsg').textContent='C칩digo inv치lido';
    const data = codeDoc.data(); if(data.usedBy) return $('codeMsg').textContent='C칩digo ya usado';
    const userRef = db.collection('users').doc(user.uid);
    if(data.type==='coins'){
      await userRef.update({coins: firebase.firestore.FieldValue.increment(data.amount||0)});
      await db.collection('codes').doc(code).update({usedBy:user.uid});
      $('codeMsg').textContent = `Recibiste ${data.amount||0} monedas!`;
      coinsEl.textContent = (Number(coinsEl.textContent) + (data.amount||0)).toString();
    } else if(data.type==='item'){
      // dar item
      const itemId = data.itemId; const itemDoc = await db.collection('items').doc(itemId).get(); if(!itemDoc.exists) return $('codeMsg').textContent='Item del c칩digo no existe';
      const it = itemDoc.data(); const newItem = {itemId, name: it.name, rarity: it.rarity, imageURL: it.imageURL||''};
      await userRef.update({inventory: firebase.firestore.FieldValue.arrayUnion(newItem)});
      await db.collection('codes').doc(code).update({usedBy:user.uid});
      $('codeMsg').textContent = `Recibiste item: ${it.name}`;
      // refresh inventory
      const updated = (await userRef.get()).data(); renderInventory(updated.inventory || []);
    }
  });

  // initial load
  (async function(){
    // ensure some default data exists (opcional): si no hay cajas, crear una demo
    const boxes = await db.collection('boxes').get();
    if(boxes.empty){
      const b = await db.collection('boxes').add({name:'Caja Demo', price:10, imageURL:'', items:[]});
      await db.collection('items').add({name:'Espada Com칰n', rarity:'comun', imageURL:''}).then(async itRef=>{
        const itId = itRef.id;
        await db.collection('boxes').doc(b.id).update({items: firebase.firestore.FieldValue.arrayUnion({itemId:itId,name:'Espada Com칰n',rarity:'comun',imageURL:'',weight:80})});
      });
      await db.collection('items').add({name:'Armadura 칄pica', rarity:'epic', imageURL:''}).then(async itRef=>{
        const itId = itRef.id;
        await db.collection('boxes').doc(b.id).update({items: firebase.firestore.FieldValue.arrayUnion({itemId:itId,name:'Armadura 칄pica',rarity:'epic',imageURL:'',weight:20})});
      });
      renderBoxes();
    } else renderBoxes();
  })();

  </script>
</body>
</html>
